<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title> Annotator Tool</title>
    <style>
        #canvas-container {
            position: relative;
            display: inline-block;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
    </style>
</head>

<body>
    <h2>Annotator Tool - Draw Bounding Boxes</h2>
    <label for="label">Label:</label>
    <select id="label">
        <option value="car">Car</option>
        <option value="truck">Truck</option>
        <option value="bus">Bus</option>
        <option value="bike">Bike</option>
        <option value="pedestrian">Pedestrian</option>
    </select>

    <div id="canvas-container">
        <img id="image" src="{{ image_url  }}" alt="Annotate Image">
        <canvas id="canvas"></canvas>
    </div>


    <div id="annotation-list" style="margin-top: 20px;">
        <h4>Saved Annotations:</h4>
        <ul id="annotataions" style="list-style-type: none; padding: 0;"></ul>
    </div>

    <script>
        function updateAnnotationList() {
            const annotationList = document.getElementById('annotataions');
            annotationList.innerHTML = '';

            annotations_list.forEach((annotation, index) => {
                const listItem = document.createElement('li');
                listItem.innerText = `${index + 1}.${annotation.label} @ [${annotation.x}, ${annotation.y}, ${annotation.width}, ${annotation.height}]`;
                listItem.style.color = annotation.color;
                annotationList.appendChild(listItem);
            });
        }

        const annotations_list = []; // Store annotations

        const labelColors = {
            car: "red",
            truck: "blue",
            bus: "green",
            bike: "orange",
            pedestrian: "purple"
        };

        const img = document.getElementById("image");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let startX = 0, startY = 0;
        let rect = {};
        let isDrawing = false;

        img.onload = function () {
            console.log("Loaded image");
            canvas.width = img.width;
            canvas.height = img.height;
            console.log("Canvas size set:", canvas.width, canvas.height);
        };

        document.addEventListener('mousedown', (e) => {
            console.log("Mouse down");
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDrawing = true;
        });

        document.addEventListener('mousemove', (e) => {
            console.log("Mouse move");
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, mouseX - startX, mouseY - startY);
        });

        document.addEventListener('mouseup', (e) => {
            console.log("Mouse up");
            if (!isDrawing) return;
            isDrawing = false;
            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            const x = Math.min(startX, endX);
            const y = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            if (width < 5 || height < 5) {
                console.log("Ignored small box.");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            const label = document.getElementById('label').value;
            const color = labelColors[label] || 'black'; // fallback to black if label not found

            // save the annotation data to the list
            annotations_list.push({ x, y, width, height, label, color });

            // Draw the bounding box with the selected color
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);

            // Draw the label text
            ctx.font = '14px Arial';
            ctx.fillStyle = color;
            ctx.fillText(label, x + 4, y - 4); // top-left corner of the box


            console.log("Saving annotation:", { x, y, width, height, label });

            // Send the annotation data to the server
            fetch('/save_annotation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x, y, width, height, label })
            })
                .then(response => response.json())
                .then(data => console.log('Annotation saved:', data));

            // update the annotations list
            updateAnnotationList();
        });
    </script>
</body>

</html>