<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title> Annotator Tool</title>
    <style>
        #canvas-container {
            position: relative;
            display: inline-block;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
    </style>
</head>

<body>
    <h2>Annotator Tool - Draw Bounding Boxes</h2>
    <div id="canvas-container">
        <img id="image" src="{{ image_url  }}" alt="Annotate Image">
        <canvas id="canvas"></canvas>
    </div>

    <script>
        const img = document.getElementById("image");
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        let startX = 0, startY = 0;
        let rect = {};
        let dragging = false;

        img.onload = function () {
            console.log("Loaded image");
            canvas.width = img.width;
            canvas.height = img.height;
            console.log("Canvas size set:", canvas.width, canvas.height);
        };

        document.addEventListener('mousedown', (e) => {
            console.log("Mouse down");
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            dragging = true;
        });

        document.addEventListener('mousemove', (e) => {
            console.log("Mouse move");
            if (!dragging) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, mouseX - startX, mouseY - startY);
        });

        document.addEventListener('mouseup', (e) => {
            console.log("Mouse up");
            if (!dragging) return;
            dragging = false;
            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            const x = Math.min(startX, endX);
            const y = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);

            if (width < 5 || height < 5) {
                console.log("Ignored small box.");
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            console.log("Saving annotation:", { x, y, width, height });

            fetch('/save_annotation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x, y, width, height })
            })
                .then(response => response.json())
                .then(data => console.log('Annotation saved:', data));

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'green';
            ctx.strokeRect(x, y, width, height);
        });
    </script>
</body>

</html>